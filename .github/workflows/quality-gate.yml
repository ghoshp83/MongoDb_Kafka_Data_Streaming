name: Quality Gate

on:
  pull_request:
    branches: [ main ]

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    
    - name: Run quality checks
      run: |
        mvn clean verify jacoco:report
        mvn org.owasp:dependency-check-maven:check
    
    - name: Check code coverage
      run: |
        COVERAGE=$(grep -o 'Total.*[0-9]*%' target/site/jacoco/index.html | grep -o '[0-9]*%' | head -1 | sed 's/%//')
        echo "Code coverage: ${COVERAGE}%"
        if [ "$COVERAGE" -lt 30 ]; then
          echo "❌ Code coverage ${COVERAGE}% is below minimum threshold of 30%"
          exit 1
        else
          echo "✅ Code coverage ${COVERAGE}% meets minimum threshold"
        fi
    
    - name: Check for security vulnerabilities
      run: |
        if [ -f target/dependency-check-report.xml ]; then
          VULNS=$(grep -c '<vulnerability>' target/dependency-check-report.xml || echo "0")
          echo "Security vulnerabilities found: $VULNS"
          if [ "$VULNS" -gt 0 ]; then
            echo "❌ Security vulnerabilities detected"
            exit 1
          else
            echo "✅ No security vulnerabilities found"
          fi
        fi
    
    - name: Quality Gate Summary
      if: always()
      run: |
        echo "## Quality Gate Results" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Build: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Code Coverage: Above threshold" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Security: No vulnerabilities" >> $GITHUB_STEP_SUMMARY